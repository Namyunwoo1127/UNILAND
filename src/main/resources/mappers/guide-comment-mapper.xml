<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.elon.boot.domain.community.guide.model.store.GuideCommentMapper">

	<!-- ResultMap 정의 -->
	<resultMap id="guideCommentResultMap" type="com.elon.boot.domain.community.guide.model.vo.GuideComment">
	    <id property="commentId" column="COMMENT_ID"/>
	    <result property="guideNo" column="GUIDE_NO"/>
	    <result property="userId" column="USER_ID"/>
	    <result property="content" column="CONTENT"/>
	    <result property="createdAt" column="CREATED_AT"/>
	    <result property="deleteYn" column="DELETE_YN"/>
	    <result property="likeCount" column="LIKE_COUNT"/>
	</resultMap>
	
	<!-- 특정 가이드의 댓글 목록 조회 (좋아요 수 포함) -->
	<select id="selectCommentsByGuideNo" resultMap="guideCommentResultMap">
	    SELECT
	        c.COMMENT_ID,
	        c.GUIDE_NO,
	        c.USER_ID,
	        c."CONTENT" AS CONTENT,  <!-- ✅ 큰따옴표 추가 -->
	        c.CREATED_AT,
	        c.DELETE_YN,
	        (SELECT COUNT(*) FROM GUIDE_COMMENT_LIKE_TBL WHERE COMMENT_ID = c.COMMENT_ID) AS LIKE_COUNT
	    FROM GUIDE_COMMENT_TBL c
	    WHERE c.GUIDE_NO = #{guideNo}
	        AND c.DELETE_YN = 'N'
	    ORDER BY c.CREATED_AT ASC
	</select>
	
	<!-- 댓글 작성 -->
	<insert id="insertComment" parameterType="com.elon.boot.domain.community.guide.model.vo.GuideComment">
	    INSERT INTO GUIDE_COMMENT_TBL (
	        COMMENT_ID,
	        GUIDE_NO,
	        USER_ID,
	        CONTENT,
	        CREATED_AT,
	        DELETE_YN
	    ) VALUES (
	        SEQ_COMMENT_ID.NEXTVAL,
	        #{guideNo},
	        #{userId},
	        #{content},
	        SYSDATE,
	        'N'
	    )
	</insert>
	
	<!-- 댓글 삭제 (논리 삭제) -->
	<update id="deleteComment">
	    UPDATE GUIDE_COMMENT_TBL
	    SET DELETE_YN = 'Y'
	    WHERE COMMENT_ID = #{commentId}
	      AND USER_ID = #{userId}
	      AND DELETE_YN = 'N'
	</update>
	
	<!-- 댓글 수 업데이트 -->
	<update id="updateCommentCount">
	    UPDATE GUIDE_TBL
	    SET COMMENT_COUNT = GREATEST(0, COMMENT_COUNT + #{increment})
	    WHERE GUIDE_NO = #{guideNo}
	</update>
	
	<!-- 댓글 ID로 조회 -->
	<select id="selectCommentById" resultMap="guideCommentResultMap">
	    SELECT 
	        COMMENT_ID,
	        GUIDE_NO,
	        USER_ID,
	        "CONTENT" AS CONTENT,  <!-- ✅ 큰따옴표 추가 -->
	        CREATED_AT,
	        DELETE_YN,
	        0 AS LIKE_COUNT
	    FROM GUIDE_COMMENT_TBL
	    WHERE COMMENT_ID = #{commentId}
	</select>

</mapper>