<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.elon.boot.domain.community.guide.model.store.GuideMapper">

    <!-- ResultMap 정의 -->
    <resultMap id="guideResultMap" type="com.elon.boot.domain.community.guide.model.vo.Guide">
        <id property="guideNo" column="GUIDE_NO"/>
        <result property="guideCategory" column="GUIDE_CATEGORY"/>
        <result property="guideTitle" column="GUIDE_TITLE"/>
        <result property="guideContent" column="GUIDE_CONTENT"/>
        <result property="viewCount" column="VIEW_COUNT"/>
        <result property="likeCount" column="LIKE_COUNT"/>
        <result property="commentCount" column="COMMENT_COUNT"/>
        <result property="isHot" column="IS_HOT"/>
        <result property="writeDate" column="WRITE_DATE"/>
        <result property="updateDate" column="UPDATE_DATE"/>
        <result property="deleteYn" column="DELETE_YN"/>
    </resultMap>

    <!-- 게시글 목록 조회 (전체) -->
    <select id="selectGuideList" resultMap="guideResultMap">
        SELECT 
            GUIDE_NO,
            GUIDE_CATEGORY,
            GUIDE_TITLE,
            GUIDE_CONTENT,
            VIEW_COUNT,
            LIKE_COUNT,
            COMMENT_COUNT,
            IS_HOT,
            WRITE_DATE,
            UPDATE_DATE,
            DELETE_YN
        FROM GUIDE_TBL
        WHERE DELETE_YN = 'N'
        <if test="category != null and category != ''">
            AND GUIDE_CATEGORY = #{category}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (
                GUIDE_TITLE LIKE '%' || #{keyword} || '%'
                OR GUIDE_CONTENT LIKE '%' || #{keyword} || '%'
            )
        </if>
        ORDER BY 
            CASE WHEN IS_HOT = 'Y' THEN 0 ELSE 1 END,
            WRITE_DATE DESC
    </select>

    <!-- 인기글 TOP 5 조회 -->
    <select id="selectPopularGuides" resultMap="guideResultMap">
        SELECT *
        FROM (
            SELECT 
                GUIDE_NO,
                GUIDE_CATEGORY,
                GUIDE_TITLE,
                GUIDE_CONTENT,
                VIEW_COUNT,
                LIKE_COUNT,
                COMMENT_COUNT,
                IS_HOT,
                WRITE_DATE,
                UPDATE_DATE,
                DELETE_YN
            FROM GUIDE_TBL
            WHERE DELETE_YN = 'N'
            ORDER BY 
                (VIEW_COUNT * 1 + LIKE_COUNT * 3 + COMMENT_COUNT * 2) DESC,
                WRITE_DATE DESC
        )
        WHERE ROWNUM <![CDATA[<=]]> 5
    </select>

</mapper>