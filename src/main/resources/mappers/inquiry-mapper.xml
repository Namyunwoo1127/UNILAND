<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.elon.boot.domain.inquiry.model.store.InquiryMapper">

  <!-- resultMap: 카멜케이스 자동매핑을 안쓴다는 가정으로 안전하게 명시 매핑 -->
  <resultMap id="InquiryMap" type="com.elon.boot.domain.inquiry.model.vo.Inquiry">
    <id     property="inquiryId"  column="INQUIRY_ID"/>
    <result property="userId"     column="USER_ID"/>
    <result property="inquiryType" column="INQUIRY_TYPE"/>
    <result property="category"    column="CATEGORY"/>
    <result property="propertyId"  column="PROPERTY_ID"/>
    <result property="realtorId"   column="REALTOR_ID"/>
    <result property="title"       column="TITLE"/>
    <result property="content"     column="CONTENT"/>    
    <result property="status"      column="STATUS"/>
    <result property="answer"      column="ANSWER"/>     
    <result property="createdAt"   column="CREATED_AT"/>
    <result property="answeredAt"  column="ANSWERED_AT"/>
    <result property="userName"    column="USER_NAME"/>
    <result property="deleteYn"    column="DELETE_YN"/>
    <result property="usersPhone"  column="USER_PHONE"/>
  </resultMap>

  <!-- 전체(관리자용) -->
  <select id="selectAllInquiriesForAdmin" resultMap="InquiryMap">
    SELECT *
      FROM INQUIRY_TBL
     WHERE DELETE_YN = 'N'
     ORDER BY CREATED_AT DESC
  </select>

  <!-- 단건 -->
  <select id="selectInquiryById" parameterType="int" resultMap="InquiryMap">
    SELECT *
      FROM INQUIRY_TBL
     WHERE INQUIRY_ID = #{value}
  </select>

  <!-- 사용자별 -->
  <select id="selectInquiriesByUserId" parameterType="string" resultMap="InquiryMap">
    SELECT *
      FROM INQUIRY_TBL
     WHERE USER_ID = #{value}
       AND DELETE_YN = 'N'
     ORDER BY CREATED_AT DESC
  </select>

  <!-- 등록 -->
  <insert id="insertInquiry" parameterType="com.elon.boot.domain.inquiry.model.vo.Inquiry">
    INSERT INTO INQUIRY_TBL (
      INQUIRY_ID, USER_ID, INQUIRY_TYPE, CATEGORY, PROPERTY_ID, REALTOR_ID,
      TITLE, CONTENT, STATUS, ANSWER, CREATED_AT, ANSWERED_AT,
      USER_NAME, DELETE_YN, USER_PHONE
    )
    VALUES (
      SEQ_INQUIRY_ID.NEXTVAL,
      #{userId}, #{inquiryType}, #{category}, #{propertyId}, #{realtorId},
      #{title}, #{content}, NVL(#{status}, 'PENDING'), #{answer},
      SYSDATE, #{answeredAt},
      #{userName}, NVL(#{deleteYn}, 'N'), #{usersPhone}
    )
  </insert>

  <!-- 답변 업데이트 -->
  <update id="updateInquiryAnswer" parameterType="map">
    UPDATE INQUIRY_TBL
       SET ANSWER = #{answer},
           STATUS = 'ANSWERED',
           ANSWERED_AT = SYSDATE
     WHERE INQUIRY_ID = #{inquiryId}
  </update>

  <!-- 삭제 플래그 -->
  <update id="deleteInquiry" parameterType="int">
    UPDATE INQUIRY_TBL
       SET DELETE_YN = 'Y'
     WHERE INQUIRY_ID = #{value}
  </update>

</mapper>
